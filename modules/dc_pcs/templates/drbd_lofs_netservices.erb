#!/bin/bash
#
#Startup script to create LOFSs for drbd on ubuntu 
#
#Description: This script attaches files from the file system to loopback
#       devices for use as drbd partitions.
#
#your partion files
DRBD_NETSERV_SRC="<%= scope.lookupvar('dc_pcs::netservices::loopback_store') %>/net_services.img"
#loopback devices
DRBD_NETSERV_DEVICE="<%= scope.lookupvar('dc_pcs::netservices::loopback_device') %>"
#losetup
LOSETUP_CMD=/sbin/losetup
#make sure the src files exist
[ -x $LOSETUP_CMD ] || exit 0
[ -e "$DRBD_NETSERV_SRC" ] || exit 0;
#includes lsb functions
. /lib/lsb/init-functions
function connect_lofs
{
         log_daemon_msg "Connecting loop devices $DRBD_NETSERV_DEVICE"
         $LOSETUP_CMD $DRBD_NETSERV_DEVICE $DRBD_NETSERV_SRC
}
function release_lofs
{
         log_daemon_msg "Releasing loop devices $DRBD_NETSERV_DEVICE"
         $LOSETUP_CMD -d $DRBD_NETSERV_DEVICE
}
case "$1" in
    start)
        connect_lofs
        ;;
    release)
        release_lofs
        ;;
    *)
        echo "Usage: /etc/init.d/drbd_lofs {start|release}"
        exit 1
        ;;
    esac
exit 0
