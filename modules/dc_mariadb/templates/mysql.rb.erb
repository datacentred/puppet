# mysql command line to execute queries
mysqlcmd = 'mysql -u <%= @dbuser %> --password=<%= @dbpassword %> -B -N -e'
# command string to get the list of databases
getdbs = %x[#{mysqlcmd} "SHOW DATABASES"].split("\n")

Facter.add(:mysql_version) do
  setcode do
    isinstalled = false,
    os = Facter.value('operatingsystem')
    case os
      when "RedHat", "CentOS", "SuSE", "Fedora"
        [ 'mysql-server', 'MySQL-server-percona', 'Percona-Server-server' ].each { |dbtype|
          if isinstalled then next
          isinstalled = system "rpm -qa #{dbtype}\* >/dev/null 2>&1"
          end
        }
      when "Debian", "Ubuntu"
        ['mysql-server', 'Percona-server', 'mariadb-server'].each { |dbtype|
          if isinstalled then next
          isinstalled = system "dpkg -l #{dbtype} 2>&1 | egrep '(^ii|^hi)' >/dev/null"
          end
        }
      else
    end
    if isinstalled then
      %x[#{mysqlcmd} "SELECT VERSION()"].to_s.strip
    end
  end
end

mysqlversion = Facter.value('mysql_version')

if mysqlversion then
	Facter.add("mysql_databases") do
		setcode do
			dbarray = []
			getdbs.each do|line|
				dbarray.push line
			end
			dblist = dbarray.join(",")
		end
	end	
end
