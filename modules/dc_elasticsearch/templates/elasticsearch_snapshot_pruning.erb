#!/usr/bin/env python

import boto
import boto.s3.connection
import datetime
import re
access_key = '<%= @ceph_access_key %>'
secret_key = '<%= @ceph_private_key %>'
ceph_provider = '<%= @ceph_access_point %>'

conn = boto.connect_s3(
        aws_access_key_id = access_key,
        aws_secret_access_key = secret_key,
        host = ceph_provider,
        calling_format = boto.s3.connection.OrdinaryCallingFormat(),
        )

date_105d_ago = datetime.datetime.now() - datetime.timedelta(days=105) #105 days because snapshots that are 90 days old reference indexes that are 104 days old.
mybucket = conn.get_bucket('<%= @backup_bucket %>')
for key in mybucket.list():
  if re.search('^indices/logstash-\d{4}\.\d{2}\.\d{2}', key.name) is not None:
    this_index_date = key.name.split('/') #get the index name out of the file name
    this_index_date = this_index_date[1].split('-')
    this_index_date = this_index_date[1]
    if datetime.datetime.strptime(this_index_date, "%Y.%m.%d") < date_105d_ago:
      key.delete()